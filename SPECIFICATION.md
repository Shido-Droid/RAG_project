================================================================================
                  RAGアプリケーション システム仕様書
                  バージョン: 1.0
================================================================================

1. システム概要
================================================================================

1.1 プロジェクト名
--------------------------------------------------------------------------------
AI Search Assistant (RAG Project)

1.2 目的
--------------------------------------------------------------------------------
Retrieval-Augmented Generation (RAG) 技術を用いて、ローカルドキュメント
とWeb検索を統合した高精度な質問応答システムを提供する。

1.3 主要機能
--------------------------------------------------------------------------------
  - ローカルドキュメント（PDF等）の検索・質問応答
  - Web検索による最新情報の取得
  - インテント検出による最適な検索戦略の選択
  - ストリーミング形式での回答生成
  - 会話履歴の管理
  - ダークモード対応のモダンUI


2. システムアーキテクチャ
================================================================================

2.1 全体構成
--------------------------------------------------------------------------------

    ユーザー
       ↓
    React Frontend
       ↓
    FastAPI Backend
       ↓
    RAG Engine
       ├→ LM Studio / LLM
       ├→ ChromaDB
       ├→ DuckDuckGo Search
       └→ Web Scraper

2.2 技術スタック
--------------------------------------------------------------------------------

▼ フロントエンド
  - フレームワーク: React 19.2.0
  - ビルドツール: Vite (Rolldown)
  - スタイリング: TailwindCSS 4.1.18
  - マークダウン: marked 17.0.1
  - シンタックスハイライト: highlight.js 11.11.1

▼ バックエンド
  - フレームワーク: FastAPI
  - 非同期処理: asyncio, uvicorn
  - ベクトルDB: ChromaDB
  - 埋め込みモデル: sentence-transformers
  - Web検索: DuckDuckGo Search
  - スクレイピング: BeautifulSoup4, trafilatura

▼ AI/ML
  - LLM: LM Studio (ローカル推論)
  - 埋め込みモデル: intfloat/multilingual-e5-large


3. 機能仕様
================================================================================

3.1 インテント検出
--------------------------------------------------------------------------------

システムは質問内容を分析し、以下のインテントに分類します：

┌────────────────┬──────────────────────────┬─────────────────────┐
│ インテント     │ 説明                     │ 検索戦略            │
├────────────────┼──────────────────────────┼─────────────────────┤
│ document_qa    │ ローカルドキュメントに   │ ChromaDBのみ検索    │
│                │ 関する質問               │                     │
├────────────────┼──────────────────────────┼─────────────────────┤
│ local_search   │ 店舗・施設情報の検索     │ Web検索             │
│                │                          │ (食べログ等優先)    │
├────────────────┼──────────────────────────┼─────────────────────┤
│ news           │ ニュース・最新情報       │ Web検索             │
│                │                          │ (ニュース優先)      │
├────────────────┼──────────────────────────┼─────────────────────┤
│ weather        │ 天気予報                 │ Web検索             │
│                │                          │ (気象庁優先)        │
├────────────────┼──────────────────────────┼─────────────────────┤
│ informational  │ 一般的な情報検索         │ Web + ChromaDB      │
├────────────────┼──────────────────────────┼─────────────────────┤
│ spec           │ 技術仕様・API情報        │ Web検索             │
│                │                          │ (公式ドキュメント   │
│                │                          │  優先)              │
├────────────────┼──────────────────────────┼─────────────────────┤
│ other          │ その他                   │ 汎用検索            │
└────────────────┴──────────────────────────┴─────────────────────┘

3.2 RAGパイプライン
--------------------------------------------------------------------------------

▼ ステップ1: ChromaDB検索
  - ユーザーの質問をベクトル化
  - ローカルドキュメントから類似度上位10件を取得

▼ ステップ2: 検索クエリ生成
  - LLMを使用して最適な検索クエリを生成（デフォルト3件）
  - インテントに応じたキーワード最適化

▼ ステップ3: Web検索
  - DuckDuckGoで各クエリを検索
  - インテントに応じて取得件数を調整（5〜10件）

▼ ステップ4: 検索結果の精緻化
  - 検索結果から追加クエリを生成（リファインメント）
  - 重複URLを除外

▼ ステップ5: コンテンツ取得とスコアリング
  - 各URLからテキストを抽出
  - インテントに応じたスコアリング関数で評価（ヒューリスティックスコア）
  - スコア上位5件（`RERANK_MAX_WEB_SOURCES`）にプリフィルタリングして高速化

▼ ステップ6: ハイブリッド・リランキングと重複排除
  - 上位ソースをチャンク分割（デフォルト800文字）
  - 埋め込みベクトルによる類似度計算
  - ヒューリスティックスコアとベクトル類似度を統合（ハイブリッド・スコアリング）
  - 重複排除（類似度92%以上）を行い、上位15件を選択

▼ ステップ7: コンテキスト構築
  - 選択された候補から文字数制限内でコンテキストを構築
  - デフォルト制限: 8000文字

▼ ステップ8: 回答生成
  - LLMに質問とコンテキストを渡して回答生成
  - マークダウン形式で構造化された回答を出力

3.3 回答スタイル
--------------------------------------------------------------------------------

ユーザーは3つの難易度レベルを選択可能：

┌────────────────┬────────────────────────────────────────────┐
│ レベル         │ 説明                                       │
├────────────────┼────────────────────────────────────────────┤
│ easy           │ 初学者向け、専門用語を避けた平易な説明     │
├────────────────┼────────────────────────────────────────────┤
│ normal         │ 標準的な説明                               │
├────────────────┼────────────────────────────────────────────┤
│ professional   │ 専門的・実務的な詳細説明                   │
└────────────────┴────────────────────────────────────────────┘

3.4 ドキュメント管理
--------------------------------------------------------------------------------

▼ アップロード
  - 対応形式: PDF, TXT, DOCX
  - 最大ファイルサイズ: 制限なし（メモリ依存）
  - 処理フロー:
      1. ファイル読み込み
      2. テキスト抽出
      3. チャンク分割（重複あり）
      4. 埋め込みベクトル生成
      5. ChromaDBに保存

▼ 削除
  - ドキュメント単位での削除
  - ChromaDBから関連するすべてのチャンクを削除


4. API仕様
================================================================================

4.1 エンドポイント一覧
--------------------------------------------------------------------------------

▼ GET /
  説明: フロントエンドのHTMLを返す（開発時は使用しない）
  レスポンス: HTML

▼ POST /api/ask
  説明: 質問を送信し、ストリーミング形式で回答を取得
  リクエストボディ:
    {
      "question": "質問文"
    }
  レスポンス: NDJSON (Newline Delimited JSON)
    {"type": "status", "content": "ドキュメントを検索中..."}
    {"type": "status", "content": "回答を生成中..."}
    {"type": "answer", "content": "回答の"}
    {"type": "answer", "content": "チャンク"}
    {"type": "sources", "content": [{"title": "...", "url": "..."}]}

▼ POST /api/upload
  説明: ドキュメントをアップロード
  リクエスト: multipart/form-data
  レスポンス:
    {
      "message": "アップロード成功",
      "filename": "document.pdf",
      "chunks": 42
    }

▼ GET /api/documents
  説明: アップロード済みドキュメント一覧を取得
  レスポンス:
    {
      "documents": [
        {
          "title": "ドキュメント名",
          "source": "document.pdf",
          "chunks": 42,
          "uploadedAt": "2026-01-15T12:00:00"
        }
      ]
    }

▼ DELETE /api/documents/{filename}
  説明: 指定したドキュメントを削除
  レスポンス:
    {
      "message": "削除成功",
      "filename": "document.pdf"
    }

▼ POST /api/reset
  説明: すべてのドキュメントとチャット履歴を削除
  レスポンス:
    {
      "message": "リセット完了"
    }


5. UI仕様
================================================================================

5.1 画面構成
--------------------------------------------------------------------------------

┌─────────────────────────────────────────────┐
│  Header (タイトル、設定、リセット)           │
├──────────┬──────────────────────────────────┤
│          │                                  │
│ Sidebar  │  Chat Area                       │
│          │                                  │
│ - 履歴   │  - メッセージ表示                │
│ - 文書   │  - コードブロック                │
│          │  - ソース表示                    │
│          │                                  │
│          ├──────────────────────────────────┤
│          │  Input Area                      │
│          │  - テキスト入力                  │
│          │  - 送信ボタン                    │
└──────────┴──────────────────────────────────┘

5.2 主要コンポーネント
--------------------------------------------------------------------------------

▼ App.jsx
  役割: アプリケーションのルートコンポーネント
  状態管理:
    - messages: チャットメッセージ配列
    - isLoading: ローディング状態
    - isSidebarOpen: サイドバー表示状態
    - documents: ドキュメント一覧
    - difficulty: 回答難易度

▼ Sidebar.jsx
  役割: サイドバー（履歴・ドキュメント管理）
  機能:
    - 会話履歴の表示
    - ドキュメントのアップロード
    - ドキュメントの削除
    - 履歴削除

▼ ChatArea.jsx
  役割: チャット表示エリア
  機能:
    - メッセージのレンダリング（マークダウン対応）
    - コードブロックのシンタックスハイライト
    - コピーボタンの自動注入
    - ソース情報の表示
    - 専門用語の解説機能

▼ ToastContext.jsx
  役割: 通知とダイアログの管理
  機能:
    - トースト通知（成功/エラー/情報）
    - カスタム確認ダイアログ

5.3 UI改善履歴
--------------------------------------------------------------------------------

▼ コードブロック機能
  - シンタックスハイライト（highlight.js）
  - 言語ラベル表示
  - ワンクリックコピーボタン
  - ダークモード対応のデザイン

▼ 通知システム
  - ブラウザ標準のalert/confirmを廃止
  - カスタムトースト通知（右下表示、自動消滅）
  - モダンな確認ダイアログ

▼ バグ修正
  - サイドバー開閉時のコードブロックヘッダー消失を修正
  - ダイアログ表示時のコードブロックヘッダー消失を修正
  - デスクトップでのサイドバー閉じるボタン表示


6. 設定・環境変数
================================================================================

6.1 主要設定（src/rag_app/config.py）
--------------------------------------------------------------------------------

┌──────────────────────┬────────────────┬──────────────────────┐
│ 設定項目             │ デフォルト値   │ 説明                 │
├──────────────────────┼────────────────┼──────────────────────┤
│ NUM_SEARCH_QUERIES   │ 3              │ 生成する検索クエリ数 │
├──────────────────────┼────────────────┼──────────────────────┤
│ DDGS_MAX_PER_QUERY   │ 8              │ 1クエリあたりの      │
│                      │                │ 検索結果数           │
├──────────────────────┼────────────────┼──────────────────────┤
│ CHARS_LIMIT          │ 3000           │ コンテキストの       │
│                      │                │ 最大文字数           │
├──────────────────────┼────────────────┼──────────────────────┤
│ HYBRID_ALPHA_DEFAULT │ 0.4            │ スコアリングの       │
│                      │                │ ハイブリッド比率     │
├──────────────────────┼────────────────┼──────────────────────┤
│ RERANK_CHUNK_SIZE    │ 800            │ リランキング時の     │
│                      │                │ チャンク文字数       │
├──────────────────────┼────────────────┼──────────────────────┤
│RERANK_MAX_WEB_SOURCES│ 5              │ チャンク化する       │
│                      │                │ 最大Webソース数      │
├──────────────────────┼────────────────┼──────────────────────┤
│ LM_SHORT_TIMEOUT     │ 15秒           │ 短いLLM呼び出しの    │
│                      │                │ タイムアウト         │
├──────────────────────┼────────────────┼──────────────────────┤
│ LM_TIMEOUT           │ 60秒           │ 長いLLM呼び出しの    │
│                      │                │ タイムアウト         │
├──────────────────────┼────────────────┼──────────────────────┤
│ CHROMA_PERSIST_DIR   │ ./chroma_db    │ ChromaDBの保存先     │
└──────────────────────┴────────────────┴──────────────────────┘

6.2 LM Studio設定
--------------------------------------------------------------------------------
  - エンドポイント: http://localhost:1234/v1/chat/completions
  - 推奨モデル: Qwen2.5-7B-Instruct以上
  - 必須設定: ローカルで起動しておく必要あり


7. デプロイメント
================================================================================

7.1 Docker構成
--------------------------------------------------------------------------------

services:
  backend:
    build: .
    ports:
      - "8000:8000"
    volumes:
      - ./chroma_db:/app/chroma_db
  
  frontend:
    build: ./my-rag-app
    ports:
      - "5173:5173"

7.2 起動方法
--------------------------------------------------------------------------------

▼ Docker（推奨）
    docker compose up --build

▼ ローカル環境
    バックエンド:
      uvicorn app:app --reload --port 8000

    フロントエンド:
      cd my-rag-app
      npm run dev

▼ ワンコマンド起動
    Mac/Linux:
      ./start.sh

    Windows:
      start.bat


8. パフォーマンス・制約
================================================================================

8.1 推奨スペック
--------------------------------------------------------------------------------
  - CPU: 4コア以上
  - RAM: 8GB以上（LLM実行時は16GB推奨）
  - ストレージ: 10GB以上の空き容量

8.2 制約事項
--------------------------------------------------------------------------------
  - LM Studioが起動していない場合、回答生成不可
  - Web検索はDuckDuckGoのレート制限に依存
  - 大量のドキュメント（100件以上）でパフォーマンス低下の可能性

8.3 最適化ポイント
--------------------------------------------------------------------------------
  - ChromaDB検索結果の上位10件に制限
  - Web検索結果のインテント別フィルタリング
  - 重複コンテンツの自動除外
  - コンテキスト文字数制限による推論時間短縮


9. セキュリティ
================================================================================

9.1 CORS設定
--------------------------------------------------------------------------------
  - 開発環境: すべてのオリジンを許可（allow_origins=["*"]）
  - 本番環境: 特定のドメインのみ許可すること

9.2 ファイルアップロード
--------------------------------------------------------------------------------
  - ファイルタイプ検証を実装
  - ファイルサイズ制限の設定を推奨

9.3 API認証
--------------------------------------------------------------------------------
  - 現状は認証なし
  - 本番環境ではAPI Key認証またはOAuth実装を推奨


10. 今後の拡張予定
================================================================================

10.1 機能追加候補
--------------------------------------------------------------------------------
  □ マルチモーダル対応（画像・音声）
  □ ユーザー認証・権限管理
  □ ドキュメントのバージョン管理
  □ 回答の評価・フィードバック機能
  □ エクスポート機能（PDF、Markdown）

10.2 技術的改善
--------------------------------------------------------------------------------
  □ ベクトルDBのスケーリング（Pinecone等への移行）
  □ LLMのストリーミング対応
  □ キャッシュ機構の実装
  □ テストカバレッジの向上


11. トラブルシューティング
================================================================================

11.1 よくある問題
--------------------------------------------------------------------------------

▼ LM Studioに接続できない
  - LM Studioが起動しているか確認
  - ポート1234が使用可能か確認
  - ファイアウォール設定を確認

▼ ChromaDBエラー
  データベースをリセット:
    rm -rf chroma_db

▼ フロントエンドが起動しない
  node_modulesを再インストール:
    cd my-rag-app
    rm -rf node_modules package-lock.json
    npm install


12. ライセンス・クレジット
================================================================================

12.1 使用ライブラリ
--------------------------------------------------------------------------------
  - React (MIT License)
  - FastAPI (MIT License)
  - ChromaDB (Apache 2.0)
  - TailwindCSS (MIT License)
  - highlight.js (BSD License)

12.2 開発者
--------------------------------------------------------------------------------
  - プロジェクト作成: 2026年1月
  - 最終更新: 2026年1月15日
